/* Complex Query 1
	Get 
*/
DELIMITER $$
    CREATE PROCEDURE get_prescription_by_consult(IN consult_id_input INT)
    SELECT consult_schedule AS 'Time', consult_date AS 'Date', consult_id AS 'Visit id', medicine_name AS 'Medicine name', instructions 
    FROM consult JOIN prescription 
    ON consult.prescription_id = prescription.prescription_id 
    JOIN recipe ON prescription.prescription_id = recipe.prescription_id 
    JOIN medicine ON recipe.medicine_id= medicine.medicine_id
    WHERE consult_id_input = consult_id
$$ DELIMITER ;





/* Complex Query Emilio */
DELIMITER $$
    CREATE PROCEDURE count_patients_by_age(IN in_start_date DATE, IN in_end_date DATE)
    SELECT YEAR(CURRENT_TIMESTAMP)-YEAR(date_of_birth)-(RIGHT(CURRENT_TIMESTAMP, 5)<RIGHT(date_of_birth, 5)) as age, 
    COUNT(YEAR(CURRENT_TIMESTAMP) - YEAR(date_of_birth) - (RIGHT(CURRENT_TIMESTAMP, 5) < RIGHT(date_of_birth, 5))) as 'Number of patients'
    FROM patient JOIN consult ON patient.patient_id = consult.patient_id
    WHERE consult.consult_date BETWEEN in_start_date AND in_end_date
    GROUP BY age
    ORDER BY age DESC
$$ DELIMITER ;

DELIMITER $$
    CREATE PROCEDURE count_patients_by_sex(IN in_start_date DATE, IN in_end_date DATE)
    SELECT sex, COUNT(sex)
    FROM patient JOIN consult on patient.patient_id = consult.patient_id
    GROUP BY sex
$$ DELIMITER ;

/*Complex Query Kurt */
DELIMITER $$
CREATE PROCEDURE `get_upcoming_consults`()
SELECT consult.consult_id AS 'Consulta', concat(doctor.first_name," ",doctor.last_name) AS 'Doctor',concat(patient.first_name," ",patient.last_name) AS 'Patient', peea AS 'Motivo de consulta', consult_date AS 'Fecha de consulta', description AS 'Descripción de diagnóstico'
    FROM doctor
    JOIN consult ON doctor.doctor_id = consult.doctor_id
    JOIN patient ON consult.patient_id = patient.patient_id
    JOIN diagnostic ON consult.consult_id = diagnostic.consult_id
    JOIN disease_catalog ON diagnostic.disease_catalog_id = disease_catalog.disease_catalog_id
    WHERE consult_date >= CURDATE()
    ORDER BY consult_date DESC
$$ DELIMITER ;
